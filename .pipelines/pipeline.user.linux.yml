# For full annotated example, please visit
#   https://cloudes.visualstudio.com/CDPX/_wiki?pagePath=%2FHome%2FYAML-Format%2FAnnotated-Example

# The following section is a metadata section that describes what kind of environment this pipeline should be executing in. Some of the
# information is redundant and will be removed in a future version.
environment:
  host:
    os: 'linux'                                                         # used to verify at runtime that correct host pool is being used
    flavor: 'ubuntu'                                                    # not used and will be removed in future
    version: '16.04'                                                    # not used and will be removed in future
  runtime:
    provider: 'appcontainer'                                            # Currently only appcontainer is supported future will bring
                                                                        # oscontainer and virtualmachine
    image: 'cdpxtest.azurecr.io/global/ubuntu-1604-all:1.0'             # This is the image that your pipeline will run in.
                                                                        # For (appcontainer), Docker Hub public Microsoft repository images
                                                                        # can be used.
                                                                        # Example microsoft/dotnet:1.1.1-sdk-nanoserver. Or the CDP team
                                                                        # vended and custom images can be used.
                                                                        # These are cdpxtest.azurecr.io/user/<user-image-name> or
                                                                        # cdpxtest.azurecr.io/samples/wsmobile (for now).
    source_mode: 'link'                                                 # 'copy' or 'link'. There is a known bug for npm and ruby on some of
                                                                        # our images that linked folder in container may cause errors on these
                                                                        # languages, for that case, use 'copy' here and pipeline will full
                                                                        # copy source into container from host before each step and full copy
                                                                        # out back to host after each step. It may be very slow if you have a
                                                                        # giant repository.


version:
  name: 'CDPX-Samples'                                                  # The uber name to attach to the artifacts generated by this pipeline.
                                                                        # Currently unused, but will be used in the future to refer to the 
                                                                        # artifacts as a group by name.
  major: 1                                                              # The major version number.
  minor: 0                                                              # The minor version number
  tag: 'alpha'                                                          # Tag to use for semantic versioning.
  system: 'patch'                                                       # Versioning scheme to use.
                                                                        # patch         - 1.0.MMddyyrrrr will be generated
                                                                        # buildrevision - 1.0.MMddyy.rrrr will be generated.


build:
  commands:                                                             # This is a sequence of script files to be executed one after another

    - !!dockerbuildcommand
      name: 'Build Sample Docker Image'
      repository_name: 'dhdemo/dockersample'
      tag: '1.0'
      publish: true
      context_folder: 'docker/docker-createenv-build'
      dockerfile_name: 'Dockerfile'
      publish_build_tag: true
      squash: false
      cache_locally: true
      env_var_suffix: 'DHDEMO_DCKR_SAMPLE'
      metadata_file:
        local_path: 'docker/docker-createenv-build/dckr_img_meta.json'
        artifact_path: 'sample\dckr_img_meta.json'
      export_to_artifact_path: 'images/sample.tar.gz'

    - !!buildcommand                                                    
      name: 'Build helloworld'                                                   # This is name for this step. The step name will be in logs and in the
                                                                        # future, will be associated with metrics, timelines, journal etc.
      command: 'build-hello.sh'                                             # A root relative path to the script to execute. Any console output
                                                                        # will be automatically pushed to VSTS logs. Any files explicitly
                                                                        # written to file can be collected via the logs list.
                                                                        # Note that the best way to code these scripts is such that they run
                                                                        # on a developer desktop. Invariably, if you can get it working on
                                                                        # your dev desktop, it should work in the CDP pipeline.
      logs:                                                             # This is a sequence of include and exclude glob patterns.
        - include:                                                      # Include patterns are evaluated fully first. All of them are relative
                                                                        # to the root of the source directory.
            - 'build.log'
          exclude:                                                      # Exclude patterns are evaluated after all include patterns are
                                                                        # evaluated.
                                                                        # There may be spurious log files. Exclude them.
      artifacts:                                                        # A sequence of entries that describes what artifacts to collect and
                                                                        # upload.
        - include: 
            - 'HelloWorld'
                                                                        # We always preserve the root relative path for every matched file.
                                                                        # Sometimes that's OK and sometimes it's not. The from, to options
                                                                        # (both are optional and either of them can be used independently)
                                                                        # allow you to remap the folder from which articacts are picked up to
                                                                        # a different location. Think of this as a effectively doing a
                                                                        # robocopy /S C:\X\Y to D;\F.

test:
  commands:                                                             # This is a sequence of script files to be executed one after another
                                                                        # in the order they appear here.
  - !!testcommand                                                     # We are going to run tests and collect back the test results for
                                                                      # publishing
    name: 'Test Hello World'                                             # If your test run does not have a name, this will be used.
    command: 'test-hello.sh'                                           # Script that runs tests.
    # testresults:                                                      # Sequence of entries indicating which test results files to collect.
    #   - title: 'All Tests'                                            # Test run title. Used by VSTS.
    #     configuration: 'Debug'                                        # Optional build configuration.
    #     platform: 'x64'                                               # Optional build platform.
    #     type: 'vstest'                                                # Test engine type. Used by VSTS. Supported values are JUnit, NUnit,
    #                                                                   # VSTest and xUnit.
    #     include:                                                      # Sequence of glob patterns indicating which test results file to
    #                                                                   # associate with this test run.
    #       - 'src\**\TestResults\**\*.log'                             # Include all TRX files under any TestResults folder under the src
    #                                                                   # folder.

  - !!vstsbuildcommand        # REQUIRED: This maps the command data to a concrete type in the CDPX orchestrator.
    name: 'External Test Hello World'  # REQUIRED: All commands have a name field. All console output captured when 
                              #           this command runs is tagged with the value of this field.
    definition_id: 33134        # REQUIRED: The ID of the VSTS definition to launch.
                              # Can be found in the URL of the definition.
    wait_mode: 'WaitNow'      # REQUIRED: Determines behavior with respect to waiting for the client build.
                              # 'WaitNow': Block execution until the child build completes.
                              # 'NoWait': Launch the child build, then ignore it and move on.
    wait_minutes: 20          # OPTIONAL: Maximum time to wait for the child build, if wait_mode is set to 'WaitNow'.
                              # If this limit is hit, cancel the child build and consider it failed.
    continue_on_error: false  # REQUIRED: Determines whether to ignore failures in the child build, if wait_mode is set to 'WaitNow'.
                              # true: ignore child build results.
                              # false: write an error and treat this step as failed if the child build does not complete successfully.

